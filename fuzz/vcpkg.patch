From 1979038709bbec8e3eb276b33cb68ead4d3711c4 Mon Sep 17 00:00:00 2001
From: lukas schwerdtfeger <lukas.schwerdtfeger@gmail.com>
Date: Thu, 5 Sep 2024 19:05:40 +0200
Subject: [PATCH 1/3] Uses external dependencies

---
 CMakeLists.txt                |  3 +-
 cmake/BuildDependencies.cmake | 89 -----------------------------------
 2 files changed, 2 insertions(+), 90 deletions(-)
 delete mode 100644 cmake/BuildDependencies.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 1e34de3..89d5547 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -34,7 +34,8 @@ include(cmake/FuzzTestFlagSetup.cmake)
 
 fuzztest_setup_fuzzing_flags()
 
-include(cmake/BuildDependencies.cmake)
+find_package(absl CONFIG REQUIRED)
+find_package(re2 CONFIG REQUIRED)
 include(cmake/FuzzTestHelpers.cmake)
 
 include_directories(${re2_SOURCE_DIR})
diff --git a/cmake/BuildDependencies.cmake b/cmake/BuildDependencies.cmake
deleted file mode 100644
index dcd7b89..0000000
--- a/cmake/BuildDependencies.cmake
+++ /dev/null
@@ -1,89 +0,0 @@
-cmake_minimum_required(VERSION 3.19)
-
-include(FetchContent)
-
-set(absl_URL https://github.com/abseil/abseil-cpp.git)
-set(absl_TAG 20240116.0)
-
-set(re2_URL https://github.com/google/re2.git)
-set(re2_TAG 2024-02-01)
-
-set(gtest_URL https://github.com/google/googletest.git)
-set(gtest_TAG v1.14.0)
-
-# From https://www.antlr.org/download.html
-set(antlr_cpp_URL https://www.antlr.org/download/antlr4-cpp-runtime-4.12.0-source.zip)
-set(antlr_cpp_MD5 acf7371bd7562188712751266d8a7b90)
-
-set(proto_URL https://github.com/protocolbuffers/protobuf.git)
-set(proto_TAG 33b78e67a92c7ba1ecc2e19a037cd2e12f4c5e27)
-
-set(nlohmann_json_URL https://github.com/nlohmann/json.git)
-set(nlohmann_json_TAG v3.11.2)
-
-if(POLICY CMP0135)
-	cmake_policy(SET CMP0135 NEW)
-	set(CMAKE_POLICY_DEFAULT_CMP0135 NEW)
-endif()
-
-FetchContent_Declare(
-  abseil-cpp
-  GIT_REPOSITORY ${absl_URL}
-  GIT_TAG        ${absl_TAG}
-)
-
-FetchContent_Declare(
-  re2
-  GIT_REPOSITORY ${re2_URL}
-  GIT_TAG        ${re2_TAG}
-)
-
-FetchContent_Declare(
-  googletest
-  GIT_REPOSITORY ${gtest_URL}
-  GIT_TAG        ${gtest_TAG}
-)
-
-FetchContent_Declare(
-  antlr_cpp
-  URL      ${antlr_cpp_URL}
-  URL_HASH MD5=${antlr_cpp_MD5}
-)
-
-if (FUZZTEST_BUILD_TESTING)
-
-  FetchContent_Declare(
-    protobuf
-    GIT_REPOSITORY ${proto_URL}
-    GIT_TAG        ${proto_TAG}
-  )
-
-  FetchContent_Declare(
-    nlohmann_json
-    GIT_REPOSITORY ${nlohmann_json_URL}
-    GIT_TAG        ${nlohmann_json_TAG}
-  )
-
-endif ()
-
-set(ABSL_PROPAGATE_CXX_STD ON)
-set(ABSL_ENABLE_INSTALL ON)
-FetchContent_MakeAvailable(abseil-cpp)
-
-set(RE2_BUILD_TESTING OFF)
-FetchContent_MakeAvailable(re2)
-
-set(GTEST_HAS_ABSL ON)
-FetchContent_MakeAvailable(googletest)
-
-FetchContent_MakeAvailable(antlr_cpp)
-
-if (FUZZTEST_BUILD_TESTING)
-
-  set(protobuf_BUILD_TESTS OFF)
-  set(protobuf_INSTALL OFF)
-  FetchContent_MakeAvailable(protobuf)
-
-  FetchContent_MakeAvailable(nlohmann_json)
-
-endif ()
-- 
2.39.2


From 7dd6451020aa9ca9f1e78c839cc5ee50c351bead Mon Sep 17 00:00:00 2001
From: lukas schwerdtfeger <lukas.schwerdtfeger@gmail.com>
Date: Thu, 5 Sep 2024 19:06:00 +0200
Subject: [PATCH 2/3] Fixes link error for missing mutext

---
 fuzztest/CMakeLists.txt | 1 +
 1 file changed, 1 insertion(+)

diff --git a/fuzztest/CMakeLists.txt b/fuzztest/CMakeLists.txt
index 613020b..73d7aed 100644
--- a/fuzztest/CMakeLists.txt
+++ b/fuzztest/CMakeLists.txt
@@ -443,6 +443,7 @@ fuzztest_cc_library(
     "internal/logging.cc"
   DEPS
     absl::strings
+    absl::synchronization
 )
 
 fuzztest_cc_library(
-- 
2.39.2


From 9ea76a1febcebe5075663a0dcc9e76313ab03bd6 Mon Sep 17 00:00:00 2001
From: lukas schwerdtfeger <lukas.schwerdtfeger@gmail.com>
Date: Thu, 5 Sep 2024 19:59:01 +0200
Subject: [PATCH 3/3] fixup! Uses external dependencies

---
 CMakeLists.txt | 1 +
 1 file changed, 1 insertion(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 89d5547..e132a3a 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -36,6 +36,7 @@ fuzztest_setup_fuzzing_flags()
 
 find_package(absl CONFIG REQUIRED)
 find_package(re2 CONFIG REQUIRED)
+find_package(GTest CONFIG REQUIRED)
 include(cmake/FuzzTestHelpers.cmake)
 
 include_directories(${re2_SOURCE_DIR})
-- 
2.39.2

