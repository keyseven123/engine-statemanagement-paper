# The Problem
- P1: The current system has no CEP functionality, which is desired/required for research projects. 
- The old NES version provides a Pattern Specification Language (PSL) based on an ANTLR grammar and the proposed mapping from  CEP operators to Analytical Stream Processing Operators, e.g., mainly join types. 
- The current system already incorporates ANTRL dependencies and bases its NESSQL on an ANTLR grammar, too. Thus, the system meets all requirements for the existing PSL.  

# Goals
- G1: In order to overcome P1, we leverage the existing grammar of the PSL in the old repository and move it to this repository. Thus, providing a declarative way to specific CEP patterns. 
- G2: We adjust the Translator of the old repository to the interface of the new repository (QueryPlanBuilder) and thus enable basic CEP functionality on top of NES. 

# Non-Goals
- NG1: The grammar is not final, as it is a research prototype it might require updates. 
- NG2: The translator is not final, i.e., it requires updates depending on the operators and implemented features available in the repository. 

# Our Proposed Solution
## NES PSL 
In the section we briefly introduce NES PSL. First, we present the general structure of a pattern and an example pattern. 
Second, we describe keywords that differ from SQL in more detail.  
### General Structure

**PATTERN** NAME := <\pattern structure\>

**FROM**    <\streams\>

[**WHERE**  <\predicates\>]

**WITHIN** <\window specifications\>

[**SELECT** <\output specification\>]

**INTO**   <\list of sinks\>

### Example Pattern 
**PATTERN** test := ( A SEQ B SEQ C SEQ D )

**FROM** inputStream AS A , inputStream1 AS B , inputStream2 AS C , inputStream3 AS D

**WHERE** C.value == D.value && A.value > 45 && B.location_type == "park" && ... 

**WITHIN** 3 MINUTES

**SELECT** A.id, A.value

**INTO** MQTT(path,topic)

### Key Words 
- The **PATTERN** clause composes logical streams with the respective CEP operators, i.e., A SEQ B specifies the temporal dependencies that an event a of stream A (i.e., a time-stamped tuple) has to occur before an event b of stream B. 
- The **FROM** clause is equivalent to SQL, it is an addition of (NES) PSL, making renaming of involved streams simpler and SQL-compatible.
- THE **WHERE** and **SELECT** clauses are optional and equivalent to SQL.  
- The **INTO** clause takes a list of sinks.  

### Implementation Details: 
![PSL.png](..%2Fresources%2FPSL.png)

In order to incorporate the declarative PSL into NebulaStream, we use the parsing tool ANTLR an available dependency of NES.
NES receives a user-provided query, e.g., via its UI and Rest Interface. Using an identifier, e.g., the keyword **PATTERN**, the string is identified as a pattern (and not a query) and transferred to the PSL Parser.
The PSL Parser is based on an ANTLR grammar that contains the general structure of the NebulsStream PSL, thus, provides syntactic validation of the query string.
Based on that grammar, ANTLR auto-generates the Lexer and the Parser classes in the respective programming language, i.e., for NebulaStream in C++.
The query string is handed over to the lexer that derives a stream of tokens from it. The stream of tokens is passed to the query parser that transforms the tokens into the Abstract Syntax Tree (AST).
The resulting AST is handed over to the **QueryPlanBuilder**, i.e., a translation module that traverses the AST and constructs the logical query plan.
To this end, the QueryPlanBuilder uses additionally auto-generated Listeners classes with enter and exit methods for each rule in the PSL grammar to obtain the operators and sources specified in the pattern.

# Proof of Concept
- [Parser Old Repository](https://github.com/nebulastream/nebulastream/tree/master/nes-coordinator/src/Parsers/NebulaPSL)
- [Tests Parser Old Repo](https://github.com/nebulastream/nebulastream/blob/master/nes-coordinator/tests/UnitTests/Services/PatternParsingServiceTest.cpp)
- [Bridging the Gap: Complex Event Processing on Stream Processing Systems](https://openproceedings.org/2024/conf/edbt/paper-114.pdf)

# Alternatives
- A1: alternative parsing tools, but stick to one for the system seems reasonable.
- A2: Using an existing CEP PSL, does not fit the needs for the Mapping, e.g., does not allow for window parameters.

# (Optional) Sources and Further Reading
- [ANTLR4](https://www.antlr.org/)

