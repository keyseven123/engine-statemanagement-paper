find_package(Argumentum REQUIRED)

add_subdirectory(src)
find_package(Argumentum REQUIRED)
get_source(unikernel-query-export UNIKERNEL_QUERY_EXPORT_SOURCES)
add_library(UnikernelQueryExport SHARED ${UNIKERNEL_QUERY_EXPORT_SOURCES})
target_include_directories(UnikernelQueryExport PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-common/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-data-types/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-compiler/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-operators/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-client/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-core/include>
)

target_link_libraries(UnikernelQueryExport PUBLIC
        nes-client
        nes-common
        nes-data-types
)

get_source(unikernel-export UNIKERNEL_EXPORT_SOURCES)
find_package(Boost 1.78.0 REQUIRED COMPONENTS system)
add_executable(NesUnikernelExporter src/main.cpp
        ${UNIKERNEL_EXPORT_SOURCES}
        ${CMAKE_CURRENT_SOURCE_DIR}/src/CLIOptions.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/OperatorHandlerTracer.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/YamlExport.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/ExportQueryOptimizer.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/ExportPhaseFactory.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/src/QueryPlanExport.cpp

        # Needed for Schema Information
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/DataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/Nextmark/NEAuctionDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/Nextmark/NEBitDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/ZipfianDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/YSBDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/DefaultDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/LightSaber/ClusterMonitoringDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/LightSaber/LinearRoadDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/LightSaber/SmartGridDataGenerator.cpp
        ${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/src/DataGeneration/LightSaber/ManufacturingEquipmentDataGenerator.cpp
)


target_include_directories(NesUnikernelExporter PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-core/tests/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-data-types/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-benchmark/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-catalogs/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-compiler/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-optimizer/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-client/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-operators/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-runtime/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-common/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-execution/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-nautilus/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-configurations/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../nes-coordinator/include>
)

target_compile_definitions(NesUnikernelExporter PRIVATE BENCHMARK_DATA_DIRECTORY="${CMAKE_CURRENT_BINARY_DIR}/benchmark-data/")
find_package(yaml-cpp REQUIRED)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-error=unused-parameter -Wno-error=unused-private-field -DUNIKERNEL_EXPORT=1 -std=c++20")

# Copy Public Headers
register_public_header_file(NesUnikernelExporter ${CMAKE_CURRENT_SOURCE_DIR}/include/OperatorHandler.hpp OperatorHandler.hpp)
register_public_header_file(NesUnikernelExporter ${CMAKE_CURRENT_SOURCE_DIR}/../nes-unikernel/include/UnikernelStage.hpp UnikernelStage.hpp)
file(GLOB HEADER_FILES ${CMAKE_CURRENT_SOURCE_DIR}/include/handler/*.hpp)
foreach (HEADER_FILE ${HEADER_FILES})
    get_filename_component(HEADER_NAME ${HEADER_FILE} NAME)
    register_public_header_file(NesUnikernelExporter ${CMAKE_CURRENT_SOURCE_DIR}/include/handler/${HEADER_NAME} handler/${HEADER_NAME})
endforeach ()
find_package(folly CONFIG REQUIRED)
target_link_libraries(NesUnikernelExporter PUBLIC
        Argumentum::argumentum
        yaml-cpp
        UnikernelCommon
        nes-common
        Folly::folly
        Folly::folly_deps
        nes-data-types
        UnikernelQueryExport
)


SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -L /usr/local/lib -fuse-ld=lld")
